# è®¢å•æœåŠ¡é›†æˆæœåŠ¡é€‚é…å™¨è¯´æ˜

## ğŸ“‹ æ¦‚è¿°

æœ¬æ–‡æ¡£æè¿°äº†è®¢å•æœåŠ¡ä¸­é›†æˆçš„å„ä¸ªæœåŠ¡é€‚é…å™¨ï¼Œè¿™äº›é€‚é…å™¨å°è£…äº†ä¸å…¶ä»–å¾®æœåŠ¡çš„Dubboè°ƒç”¨ï¼Œä¿æŒäº†è®¢å•æœåŠ¡çš„ç‹¬ç«‹æ€§å’Œå¯ç»´æŠ¤æ€§ã€‚

## ğŸ”§ å·²å®ç°çš„æœåŠ¡é€‚é…å™¨

### 1. InventoryServiceAdapter - åº“å­˜æœåŠ¡é€‚é…å™¨

**ä½ç½®**: `com.mall.order.adapter.InventoryServiceAdapter`

**åŠŸèƒ½**:
- æ‰¹é‡æ£€æŸ¥åº“å­˜å¯ç”¨æ€§
- æ‰¹é‡é”å®šåº“å­˜
- æ‰£å‡å·²é”å®šçš„åº“å­˜
- é‡Šæ”¾é”å®šçš„åº“å­˜
- é€€è¿˜åº“å­˜ï¼ˆç”¨äºé€€è´§ï¼‰
- è·å–åº“å­˜ä¿¡æ¯

**ä¸»è¦æ–¹æ³•**:
```java
// æ£€æŸ¥åº“å­˜å¯ç”¨æ€§
public void checkStockAvailability(List<OrderItem> items)

// æ‰¹é‡é”å®šåº“å­˜
public List<StockLockVO> batchLockStock(List<OrderItem> items, String orderNo, Long userId)

// æ‰£å‡é”å®šåº“å­˜
public void deductLockedStock(String orderNo)

// é‡Šæ”¾é”å®šåº“å­˜
public void unlockStock(String orderNo)

// é€€è¿˜åº“å­˜
public void returnStock(List<OrderItem> items, String orderNo)
```

### 2. UserServiceAdapter - ç”¨æˆ·æœåŠ¡é€‚é…å™¨

**ä½ç½®**: `com.mall.order.adapter.UserServiceAdapter`

**åŠŸèƒ½**:
- è·å–ç”¨æˆ·åŸºæœ¬ä¿¡æ¯
- è·å–æ”¶è´§åœ°å€ä¿¡æ¯
- ç§¯åˆ†æ“ä½œï¼ˆæ‰£å‡ã€é€€è¿˜ã€èµ é€ï¼‰
- æˆé•¿å€¼ç®¡ç†
- ä½™é¢æ“ä½œ
- ä¼šå‘˜ä¿¡æ¯è·å–

**ä¸»è¦æ–¹æ³•**:
```java
// è·å–ç”¨æˆ·ä¿¡æ¯
public UserVO getUserInfo(Long userId)

// è·å–åœ°å€ä¿¡æ¯
public AddressVO getAddress(Long addressId)

// ç§¯åˆ†æ“ä½œ
public void deductPoints(Long userId, Integer points, String orderNo)
public void returnPoints(Long userId, Integer points, String orderNo)
public void awardPointsAndGrowth(Long userId, Integer points, Integer growth, String orderNo)

// éªŒè¯ç§¯åˆ†å’Œä½™é¢
public boolean checkPointsSufficient(Long userId, Integer usePoints)
public boolean checkBalanceSufficient(Long userId, BigDecimal amount)
```

### 3. ProductServiceAdapter - å•†å“æœåŠ¡é€‚é…å™¨

**ä½ç½®**: `com.mall.order.adapter.ProductServiceAdapter`

**åŠŸèƒ½**:
- æ‰¹é‡è·å–SKUä¿¡æ¯
- æ ¡éªŒå•†å“çŠ¶æ€
- è¿è´¹è®¡ç®—ï¼ˆç®€åŒ–ç‰ˆï¼‰
- æ£€æŸ¥å•†å“å¯ç”¨æ€§

**ä¸»è¦æ–¹æ³•**:
```java
// è·å–å•†å“ä¿¡æ¯
public Map<Long, SkuVO> getSkuInfoMap(List<Long> skuIds)
public SkuVO getSkuInfo(Long skuId)

// æ ¡éªŒå•†å“
public void validateProductStatus(List<Long> skuIds)
public void checkProductAvailable(List<Long> skuIds)

// è¿è´¹è®¡ç®—
public BigDecimal calculateFreight(Long spuId, String provinceCode, String cityCode, Integer quantity)
```

### 4. PaymentServiceAdapter - æ”¯ä»˜æœåŠ¡é€‚é…å™¨

**ä½ç½®**: `com.mall.order.adapter.PaymentServiceAdapter`

**åŠŸèƒ½**:
- åˆ›å»ºæ”¯ä»˜è®¢å•
- æŸ¥è¯¢æ”¯ä»˜çŠ¶æ€
- å–æ¶ˆ/å…³é—­æ”¯ä»˜
- éªŒè¯æ”¯ä»˜ä¿¡æ¯

**ä¸»è¦æ–¹æ³•**:
```java
// åˆ›å»ºæ”¯ä»˜
public PaymentResultVO createPayment(String orderNo, Long userId, Integer paymentType, 
                                   BigDecimal paymentAmount, String subject, String description,
                                   String returnUrl, String notifyUrl, LocalDateTime expireTime)

// æŸ¥è¯¢æ”¯ä»˜çŠ¶æ€
public PaymentVO queryPaymentByOrderNo(String orderNo)

// éªŒè¯æ”¯ä»˜
public boolean isPaymentSuccess(String orderNo)
public boolean validatePaymentAmount(String orderNo, BigDecimal expectedAmount)
```

## ğŸ”„ OrderServiceImplçš„ä¸»è¦æ”¹è¿›

### 1. è®¢å•åˆ›å»ºæµç¨‹ä¼˜åŒ–

**ä¹‹å‰**:
```java
// åº“å­˜ç›¸å…³æ–¹æ³•éƒ½è¢«æ³¨é‡Šæ‰äº†
private void lockStock(List<OrderItem> items) {
    // TODO: è°ƒç”¨åº“å­˜æœåŠ¡
}
```

**ç°åœ¨**:
```java
// 5. æ ¡éªŒå•†å“å¯ç”¨æ€§å’Œåº“å­˜
List<Long> skuIds = orderItems.stream()
        .map(OrderItem::getSkuId)
        .collect(Collectors.toList());
productServiceAdapter.checkProductAvailable(skuIds);
inventoryServiceAdapter.checkStockAvailability(orderItems);

// 6. é”å®šåº“å­˜
String orderNo = generateOrderNo();
inventoryServiceAdapter.batchLockStock(orderItems, orderNo, userId);

// 9. æ‰£å‡åº“å­˜
inventoryServiceAdapter.deductLockedStock(order.getOrderNo());

// 11. æ‰£å‡ç§¯åˆ†
if (request.getUsePoints() != null && request.getUsePoints() > 0) {
    userServiceAdapter.deductPoints(userId, request.getUsePoints(), order.getOrderNo());
}
```

### 2. è®¢å•å–æ¶ˆæµç¨‹ä¼˜åŒ–

**ä¹‹å‰**:
```java
// TODO: è°ƒç”¨ç”¨æˆ·æœåŠ¡é€€è¿˜ç§¯åˆ†
// TODO: è°ƒç”¨åº“å­˜æœåŠ¡é‡Šæ”¾åº“å­˜
```

**ç°åœ¨**:
```java
// é‡Šæ”¾åº“å­˜
inventoryServiceAdapter.unlockStock(order.getOrderNo());

// é€€è¿˜ç§¯åˆ†
if (order.getUsePoints() != null && order.getUsePoints() > 0) {
    userServiceAdapter.returnPoints(order.getUserId(), order.getUsePoints(), order.getOrderNo());
}
```

### 3. è®¢å•å®Œæˆæµç¨‹ä¼˜åŒ–

**ä¹‹å‰**:
```java
// TODO: è°ƒç”¨ç”¨æˆ·æœåŠ¡å¢åŠ ç§¯åˆ†å’Œæˆé•¿å€¼
```

**ç°åœ¨**:
```java
// è°ƒç”¨ç”¨æˆ·æœåŠ¡å¢åŠ ç§¯åˆ†å’Œæˆé•¿å€¼
userServiceAdapter.awardPointsAndGrowth(order.getUserId(), totalPoints, totalGrowth, order.getOrderNo());
```

### 4. æ”¯ä»˜æµç¨‹ä¼˜åŒ–

**ä¹‹å‰**:
```java
// å¤æ‚çš„PaymentCreateRequestæ„å»ºå’ŒResultå¤„ç†
PaymentCreateRequest paymentRequest = new PaymentCreateRequest();
// ... è®¾ç½®å„ç§å‚æ•°
Result<PaymentResultVO> paymentResult = paymentFeignClient.createPayment(paymentRequest);
if (!paymentResult.isSuccess()) {
    throw new BusinessException("Failed to create payment");
}
```

**ç°åœ¨**:
```java
// ç®€æ´çš„é€‚é…å™¨è°ƒç”¨
PaymentResultVO paymentResult = paymentServiceAdapter.createPayment(
    order.getOrderNo(),
    order.getUserId(),
    request.getPaymentType(),
    order.getPayAmount(),
    "è®¢å•æ”¯ä»˜",
    "è®¢å•å·ï¼š" + order.getOrderNo(),
    request.getReturnUrl(),
    request.getNotifyUrl(),
    order.getExpireTime()
);
```

## ğŸ“¦ ä¾èµ–é…ç½®

### Mavenä¾èµ– (pom.xml)

```xml
<!-- APIæ¨¡å—ä¾èµ– -->
<dependency>
    <groupId>com.mall</groupId>
    <artifactId>user-api</artifactId>
    <version>${project.version}</version>
</dependency>

<dependency>
    <groupId>com.mall</groupId>
    <artifactId>product-api</artifactId>
    <version>${project.version}</version>
</dependency>

<dependency>
    <groupId>com.mall</groupId>
    <artifactId>inventory-api</artifactId>
    <version>${project.version}</version>
</dependency>

<dependency>
    <groupId>com.mall</groupId>
    <artifactId>payment-api</artifactId>
    <version>${project.version}</version>
</dependency>
```

### Dubboé…ç½® (application.yml)

```yaml
dubbo:
  application:
    name: ${spring.application.name}
    version: 1.0.0
  registry:
    address: nacos://${NACOS_SERVER_ADDR:localhost:8848}
    group: mall
    namespace: ${NACOS_NAMESPACE:public}
  protocol:
    name: dubbo
    port: ${DUBBO_PORT:20883}
    serialization: hessian2
  provider:
    group: mall
    version: 1.0.0
    timeout: 30000
    retries: 0
  consumer:
    group: mall
    version: 1.0.0
    timeout: 30000
    retries: 2
    check: false
  scan:
    base-packages: com.mall.order
```

## ğŸ¯ ä¼˜åŠ¿å’Œç‰¹ç‚¹

### 1. æ¨¡å—ç‹¬ç«‹æ€§
- è®¢å•æœåŠ¡åªä¾èµ–APIå®šä¹‰ï¼Œä¸ä¾èµ–å…·ä½“å®ç°
- æœåŠ¡é€‚é…å™¨å°è£…äº†å¤æ‚çš„Dubboè°ƒç”¨é€»è¾‘
- ä¾¿äºå•å…ƒæµ‹è¯•å’ŒMock

### 2. é”™è¯¯å¤„ç†
- ç»Ÿä¸€çš„å¼‚å¸¸å¤„ç†æœºåˆ¶
- ä¼˜é›…çš„é™çº§å¤„ç†
- è¯¦ç»†çš„æ—¥å¿—è®°å½•

### 3. æ€§èƒ½ä¼˜åŒ–
- æ‰¹é‡æ“ä½œå‡å°‘ç½‘ç»œè°ƒç”¨
- åˆç†çš„è¶…æ—¶å’Œé‡è¯•é…ç½®
- å¼‚æ­¥å¤„ç†éå…³é”®æ“ä½œ

### 4. å¯ç»´æŠ¤æ€§
- æ¸…æ™°çš„æ–¹æ³•å‘½åå’Œæ–‡æ¡£
- ç»Ÿä¸€çš„è°ƒç”¨æ¨¡å¼
- æ˜“äºæ‰©å±•å’Œä¿®æ”¹

## ğŸš€ ä½¿ç”¨å»ºè®®

1. **ç›‘æ§æœåŠ¡è°ƒç”¨**: æ·»åŠ é€‚å½“çš„ç›‘æ§å’Œæ—¥å¿—
2. **æ€§èƒ½è°ƒä¼˜**: æ ¹æ®å®é™…è´Ÿè½½è°ƒæ•´è¶…æ—¶å’Œé‡è¯•å‚æ•°
3. **å¼‚å¸¸å¤„ç†**: å®Œå–„å„ç§å¼‚å¸¸åœºæ™¯çš„å¤„ç†é€»è¾‘
4. **ç¼“å­˜ç­–ç•¥**: å¯¹é¢‘ç¹æŸ¥è¯¢çš„æ•°æ®æ·»åŠ ç¼“å­˜
5. **ç†”æ–­é™çº§**: é…ç½®Sentinelç†”æ–­è§„åˆ™

## ğŸ“ æ³¨æ„äº‹é¡¹

1. **ä¾èµ–å¯åŠ¨é¡ºåº**: ç¡®ä¿è¢«è°ƒç”¨çš„æœåŠ¡å…ˆå¯åŠ¨
2. **ç½‘ç»œé…ç½®**: ç¡®ä¿æœåŠ¡é—´ç½‘ç»œè¿é€šæ€§
3. **ç‰ˆæœ¬å…¼å®¹**: ä¿æŒAPIç‰ˆæœ¬çš„å…¼å®¹æ€§
4. **äº‹åŠ¡å¤„ç†**: æ³¨æ„åˆ†å¸ƒå¼äº‹åŠ¡çš„ä¸€è‡´æ€§é—®é¢˜
5. **æ•°æ®ä¸€è‡´æ€§**: å¤„ç†å¥½å¹¶å‘åœºæ™¯ä¸‹çš„æ•°æ®ä¸€è‡´æ€§

## ğŸ”® åç»­ä¼˜åŒ–è®¡åˆ’

1. **è¡¥å……ç¼ºå¤±æ¥å£**: 
   - ä¼˜æƒ åˆ¸æœåŠ¡æ¥å£
   - è¿è´¹è®¡ç®—æ¥å£
   - ç‰©æµè·Ÿè¸ªæ¥å£

2. **æ€§èƒ½ä¼˜åŒ–**:
   - å¼•å…¥å¼‚æ­¥å¤„ç†
   - æ‰¹é‡æ“ä½œä¼˜åŒ–
   - ç¼“å­˜ç­–ç•¥å®Œå–„

3. **ç›‘æ§å®Œå–„**:
   - æœåŠ¡è°ƒç”¨ç›‘æ§
   - æ€§èƒ½æŒ‡æ ‡æ”¶é›†
   - å‘Šè­¦æœºåˆ¶å»ºç«‹ 